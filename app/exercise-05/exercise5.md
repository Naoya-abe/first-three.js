# Exercise 5: ã€Œæ„æ€ã‚’æŒã¤ç²’å­ãŸã¡ã€ (Interactive Particles)

## ãƒ†ãƒ¼ãƒ: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¨æ•°å­¦çš„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (Lv.50)

Exercise 4ã§ã¯ã€å…¨ã¦ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã«åŒã˜ãƒ«ãƒ¼ãƒ«ï¼ˆé›¨ã®ã‚ˆã†ã«è½ä¸‹ï¼‰ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚
ä»Šå›ã¯ã€**ã€Œãƒã‚¦ã‚¹ã®ä½ç½®ã€** ã¨ã„ã†å‹•çš„ãªæƒ…å ±ã‚’å–ã‚Šå…¥ã‚Œã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ä¸€ç²’ä¸€ç²’ãŒè¨ˆç®—ã‚’è¡Œã£ã¦é€ƒã’ãŸã‚Šé›†ã¾ã£ãŸã‚Šã™ã‚‹è¡¨ç¾ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### ğŸ“‹ ãƒŸãƒƒã‚·ãƒ§ãƒ³: ã€Œãƒã‚¦ã‚¹ã‹ã‚‰é€ƒã’ã‚‹ç²’å­ã€

* **ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°:** 10,000å€‹ä»¥ä¸Šã€‚
* **åˆæœŸé…ç½®:** Z=0 ã®å¹³é¢ä¸Šã«ã€æ ¼å­çŠ¶ï¼ˆGridï¼‰ã¾ãŸã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚
* **ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³:**
    * ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ãŒè¿‘ã¥ãã¨ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãŒãã®å ´ã‹ã‚‰**é€ƒã’ã‚‹ï¼ˆã¾ãŸã¯é›†ã¾ã‚‹ï¼‰**ã‚ˆã†ã«å‹•ã‹ã—ã¦ãã ã•ã„ã€‚
    * ãƒã‚¦ã‚¹ãŒé ã–ã‹ã‚‹ã¨ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯**å…ƒã®ä½ç½®ã«æˆ»ã‚ã†ã¨ã™ã‚‹**å‹•ãï¼ˆå¾©å…ƒåŠ›ï¼‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

#### æ§‹é€ ã®ãƒ’ãƒ³ãƒˆ: 3Dç©ºé–“ã§ã®ãƒã‚¦ã‚¹ä½ç½®å–å¾—

ç”»é¢ä¸Šã®ãƒã‚¦ã‚¹åº§æ¨™ï¼ˆ2Dï¼‰ã‚’ã€3Dç©ºé–“ã®åº§æ¨™ï¼ˆWorld Positionï¼‰ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
R3Fã§ã¯ã€**ã€Œè¦‹ãˆãªã„æ¿ã€** ã‚’ç½®ã„ã¦ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ã®ãŒå®šçŸ³ã§ã™ã€‚

```jsx
const InteractiveParticles = () => {
  // ãƒã‚¦ã‚¹ä½ç½®ã‚’ä¿å­˜ã™ã‚‹Ref (åˆæœŸå€¤ã¯ç”»é¢å¤–)
  const mouseRef = useRef([1000, 1000, 0]);

  // ãƒã‚¦ã‚¹ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  const handlePointerMove = (e) => {
    // è¦‹ãˆãªã„æ¿ä¸Šã®äº¤ç‚¹åº§æ¨™ã‚’å–å¾—
    mouseRef.current = [e.point.x, e.point.y, e.point.z];
  };

  return (
    <>
      {/* 1. ãƒã‚¦ã‚¹ä½ç½®å–å¾—ç”¨ã®é€æ˜ãªæ¿ (Z=0) */}
      <mesh visible={false} onPointerMove={handlePointerMove}>
        <planeGeometry args={[100, 100]} />
      </mesh>

      {/* 2. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æœ¬ä½“ */}
      <Particles mouseRef={mouseRef} />
    </>
  );
};
```

### ğŸ§  é›ãˆã‚‰ã‚Œã‚‹ã‚¹ã‚­ãƒ«

1.  **Raycasterã®ç†è§£**: 3Dç©ºé–“ã§ã€Œãƒã‚¦ã‚¹ãŒã©ã“ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã€ã‚’åˆ¤å®šã™ã‚‹ä»•çµ„ã¿ã€‚
2.  **ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—ã®åŸºç¤**: ã€Œãƒã‚¦ã‚¹ã¨ç‚¹ã®è·é›¢ã€ã‚’ä¸‰å¹³æ–¹ã®å®šç†ã§æ±‚ã‚ã€ã€Œé€ƒã’ã‚‹æ–¹å‘ã€ã‚’å˜ä½ãƒ™ã‚¯ãƒˆãƒ«ã§è¨ˆç®—ã™ã‚‹ã€‚
3.  **ç·šå½¢è£œé–“ (Lerp)**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’æ»‘ã‚‰ã‹ã«å…ƒã®ä½ç½®ã«æˆ»ã™ãŸã‚ã®ç‰©ç†æŒ™å‹•ã®åŸºç¤ã€‚

### ğŸš€ å¿œç”¨ãƒŸãƒƒã‚·ãƒ§ãƒ³: ã€Œæ³¢ç´‹ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€

å˜ã«é€ƒã’ã‚‹ã ã‘ã§ãªãã€**ã€Œæ³¢ï¼ˆWaveï¼‰ã€** ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

* **è¿½åŠ ãƒŸãƒƒã‚·ãƒ§ãƒ³:**
    * ãƒã‚¦ã‚¹ã®ä½ç½®ã‚’ä¸­å¿ƒã¨ã—ã¦ã€sinæ³¢ã‚’ä½¿ã£ã¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®Zåº§æ¨™ï¼ˆé«˜ã•ï¼‰ã‚’æ³¢æ‰“ãŸã›ã¦ãã ã•ã„ã€‚
    * ãƒã‚¦ã‚¹ãŒå‹•ãã¨ã€æ°´é¢ã®ã‚ˆã†ã«æ³¢ç´‹ãŒåºƒãŒã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

#### ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆ: æ•°å­¦ã®æ–¹ç¨‹å¼

`useFrame` ã®ä¸­ã§ã€å„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã«å¯¾ã—ã¦ä»¥ä¸‹ã®è¨ˆç®—ã‚’è¡Œã„ã¾ã™ã€‚

```javascript
useFrame(() => {
  const positions = geometry.attributes.position.array;

  for(let i = 0; i < count; i++) {
    // 1. å„ç‚¹ã®ã€Œæœ¬æ¥ã®ä½ç½®ã€ã‚’å–å¾—ï¼ˆåˆ¥é€”ä¿å­˜ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ï¼‰
    const ix = initialPositions[i * 3];
    const iy = initialPositions[i * 3 + 1];

    // 2. ãƒã‚¦ã‚¹ã¨ã®è·é›¢ (dx, dy) ã‚’è¨ˆç®—
    const dx = mouseRef.current[0] - ix;
    const dy = mouseRef.current[1] - iy;
    const distance = Math.sqrt(dx * dx + dy * dy);

    // 3. è·é›¢ã«å¿œã˜ãŸåŠ›ã‚’åŠ ãˆã‚‹ (ä¾‹: è¿‘ã„ã»ã©Zåº§æ¨™ã‚’é«˜ã)
    // Math.sin() ã‚„ Math.exp() ã‚’çµ„ã¿åˆã‚ã›ã¦æ³¢ã‚’ä½œã‚‹
    const force = Math.max(0, 5 - distance); // è·é›¢5ä»¥å†…ãªã‚‰åŠ›ãŒåƒã
    const z = Math.sin(distance * 2 + time) * force;

    // 4. åº§æ¨™æ›´æ–°
    positions[i * 3 + 2] = z;
  }
  geometry.attributes.position.needsUpdate = true;
});
```

ã“ã®è¨ˆç®—ã‚’1ä¸‡å›Ã—æ¯ãƒ•ãƒ¬ãƒ¼ãƒ (60fps)ã§è¡Œã£ã¦ã‚‚è€ãˆã‚‰ã‚Œã‚‹ã‹ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é™ç•Œã«æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã‚‚ã—é‡ã„ã¨æ„Ÿã˜ãŸã‚‰ã€ãã‚ŒãŒæ¬¡ã®ã€ŒLv.70 ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ï¼ˆGPUå‡¦ç†ï¼‰ã€ã¸é€²ã‚€åˆå›³ã§ã™ã€‚